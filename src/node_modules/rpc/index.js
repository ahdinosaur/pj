var Rpc = require('multiplex-rpc')
var validate = require('tcomb-validation').validate
var inspect = require('tcomb-doc').inspect
var mapValues = require('lodash.mapvalues')

module.exports = Pj

function Pj (config) {
  return Rpc(
    mapValues(config.modes, function (modeName) {
      var mode = require('mode-' + modeName)
      return command(mode)
    })
  )
}

function command (mode) {
  var type = mode.type

  return function run (options, cb) {
    // if no options given, return usage docs
    if (options == null) {
      return cb(inspect(type))
    }
  
    // validate given options
    var result = validate(options, type)
    if (!result.isValid()) {
      return cb(result.errors)
    }

    cb(null, mode.fn(options))
  }
}
