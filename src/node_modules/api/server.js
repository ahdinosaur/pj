var fs = require('fs')
var assign = require('lodash.assign')
var websocket = require('websocket-stream')
var protobuf = require('protocol-buffers')
var through = require('through2')

var messages = protobuf(fs.readFileSync(__dirname + '/messages.proto'))

var handleApi = require('./handler')

module.exports = createApi

function createApi (server, config) {
  return websocket.createServer(
    assign({
      server: server
    }, config),
    function handleApi (stream) {
      var encodedStream = through.obj(function (pixels, enc, cb) {
        console.log("pixels", pixels)
        cb(null, messages.Pixels.encode(pixels))
        //cb(null, JSON.stringify(pixels))
      })

      encodedStream
      .pipe(stream)

      handleApi(encodedStream)
    }
  )
}
